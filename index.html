<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easemob MQTT Demo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
    <!-- paho-mqtt 文档 https://www.eclipse.org/paho/files/jsdoc/Paho.MQTT.Client.html -->
    <script type="text/javascript">

        var host = '//xxx.xxx.xxx.xxx';// 设置当前用户的接入点域名，接入点获取方法请参考接入准备章节文档
        var port = 80;//WebSocket 协议服务端口，如果是走 HTTPS，设置443端口
        var topic = 't/t1';//需要订阅或发送消息的topic名称
        var useTLS = false;//是否走加密 HTTPS，如果走 HTTPS，设置为 true
        var cleansession = true;
        var deviceId = 'deviceId';//MQTT 用户自定义deviceID
        var clientId = deviceId + '@AppID';//deviceID@AppID
        var reconnectTimeout = 2000;
        var username = 'test'
        var password = 'test123'

        var mqtt;

        /**
         * 客户端获取token(password)代码示例如下： 
        */
        function getAccessToken() {
            var grantType = 'password'
            var request = new XMLHttpRequest()
            var baseUrl = 'a3.easemob.com'
            var orgName = 'easemob-test'
            var appName = 'ease-test'
            var api = `http://${baseUrl}/${orgName}/${appName}/token`
            var token = ''

            request.open('post', api);

            request.onreadystatechange = function () {
                if (request.readyState == 4 && request.status == 200) {
                    var res = JSON.parse(request.responseText);
                    token = res.access_token
                    console.log(token, 'accessToken')
                }
            }

            var params = {
                grant_type: grantType,
                username: 'test',
                password: 'test1'
            }

            request.send(JSON.stringify(params))
        }

        // getAccessToken()

        function MQTTconnect() {
            mqtt = new Paho.MQTT.Client(
                host,//MQTT 域名
                port,//WebSocket 端口，如果使用 HTTPS 加密则配置为443,否则配置80
                clientId//客户端 ClientId
            );

            var options = {
                timeout: 3,
                onSuccess: onConnect,
                mqttVersion: 4,
                cleanSession: cleansession,
                onFailure: function (message) {
                    setTimeout(MQTTconnect, reconnectTimeout);
                }
            };

            mqtt.onConnectionLost = onConnectionLost;
            mqtt.onMessageArrived = onMessageArrived;

            if (username != null) {
                options.userName = username;
                options.password = password;
                options.useSSL = useTLS;//如果使用 HTTPS 加密则配置为 true
            }
            mqtt.connect(options);
        }

        function onConnect() {
            mqtt.subscribe(topic, { qos: 1 }); // 订阅消息
            message = new Paho.MQTT.Message("Hello mqtt!!");//set body
            message.destinationName = topic;// set topic
            mqtt.send(message);
            // mqtt.unsubscribe(topic) // 取消订阅
        }

        function onConnectionLost(response) {
            setTimeout(MQTTconnect, reconnectTimeout);
        };

        function onMessageArrived(message) {
            var topic = message.destinationName;
            var payload = message.payloadString;
            console.log("recv msg : " + topic + "   " + payload);
        };

        MQTTconnect();


    </script>
</head>

<body>
</body>

</html>